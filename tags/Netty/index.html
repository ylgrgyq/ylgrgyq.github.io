



	<article>
	
		<h1><a href="/2016/07/17/found-a-bug-in-netty/">è¿½è¸ª Netty å¼‚å¸¸å ç”¨å †å¤–å†…å­˜çš„ç»éªŒåˆ†äº«</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-07-17</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Java/">Java</a> <a class="article__tag-link" href="/tags/Netty/">Netty</a>
			</span>
		
	</div>

	

	
		<p>æœ¬æ–‡è®°è¿°äº†å®šä½ Netty çš„ä¸€å¤„æ¼æ´çš„å…¨è¿‡ç¨‹ã€‚äº‹æƒ…çš„èµ·å› æ˜¯æˆ‘ä»¬ä¸€ä¸ªä½¿ç”¨äº† <a href="http://netty.io" target="_blank" rel="external">Netty</a> çš„æœåŠ¡ï¼Œéšç€è¿è¡Œæ—¶é—´çš„å¢é•¿ï¼Œå…¶å ç”¨çš„å †å¤–å†…å­˜ä¼šé€æ­¥æ”€å‡ï¼Œå¤§æ¦‚æŒç»­è¿è¡Œä¸‰å››å¤©å·¦å³ï¼Œå †å¤–å†…å­˜ä¼šè¢«å…¨éƒ¨å æ»¡ï¼Œç„¶ååªèƒ½é‡å¯æ¥è§£å†³é—®é¢˜ã€‚å¥½åœ¨æœåŠ¡æ˜¯å†—ä½™é…ç½®çš„ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨è¿›è¡Œ Load Balanceï¼Œæ‰€ä»¥æ¯æ¬¡é‡å¯ä¸ä¼šå¸¦æ¥ä»€ä¹ˆæŸå¤±ã€‚</p>
<p>ä»ç°è±¡ä¸Šåˆ†æï¼Œæˆ‘ä»¬èƒ½ç¡®å®šä¸€å®šæ˜¯æœåŠ¡å†…éƒ¨æœ‰åœ°æ–¹å‡ºç°äº†å†…å­˜æ³„éœ²ã€‚åœ¨è¿™ä¸ªå‡ºé—®é¢˜çš„æœåŠ¡ä¸Šæœ‰å¤§é‡çš„ç½‘ç»œ IO æ“ä½œï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† PooledByteBufAllocator æ¥åˆ†é… PooledDirectByteBufã€‚å› ä¸ºæ˜¯å †å¤–å†…å­˜æ³„éœ²ï¼Œæ‰€ä»¥ç¬¬ä¸€ç§å¯èƒ½å°±æ˜¯æˆ‘ä»¬åœ¨æŸä¸ªåœ°æ–¹åˆ†é…äº†å†…å­˜ä½†å¿˜è®°äº†é‡Šæ”¾ã€‚æˆ‘ä»¬ä»”ç»†æ£€æŸ¥äº†ä¸ä¸šåŠ¡ç›¸å…³çš„ ChannelHandler ä½†å¹¶æœªå‘ç°é—®é¢˜ï¼Œäºæ˜¯åˆå°† Netty çš„ io.netty.leakDetectionLevel è®¾ç½®åˆ° Advanced çº§åˆ«ï¼Œæ”¾åœ¨ Beta ç¯å¢ƒä¸Šè¿›è¡Œæµ‹è¯•ã€‚åœ¨æœåŠ¡è¿ç»­è¿è¡Œäº†å‡ å¤©å¹¶å³å°†å› å†…å­˜ä¸è¶³å†æ¬¡é‡å¯ä¹‹å‰ï¼Œæˆ‘ä»¬ä»æ—¥å¿—ä¸­ä¹Ÿæ²¡æœ‰å‘ç°ä»»ä½•ç”± Netty æ‰“å‡ºæ¥çš„å†…å­˜æ³„éœ²çš„æŠ¥è­¦ä¿¡æ¯ã€‚éšåæˆ‘ä»¬åˆå°† io.netty.leakDetectionLevel è®¾ç½®åˆ° Paranoid æ¥é‡æ–°æµ‹è¯•ï¼Œä½†ä¾ç„¶æ²¡æœ‰å‘ç°æœ‰å…³ Netty å†…å­˜æ³„éœ²çš„ç›¸å…³æ—¥å¿—ã€‚</p>
<p>åœ¨æ’æŸ¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°è™½ç„¶å¼•èµ·æœåŠ¡é‡å¯çš„åŸå› æ˜¯å †å¤–å†…å­˜ä¸è¶³ï¼Œä½†å®é™…å †å†…å†…å­˜ä¹Ÿæœ‰å°å¹…åº¦æ”€å‡ã€‚èµ·åˆæˆ‘ä»¬ä»¥ä¸ºè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œå› ä¸ºæœ‰ä½¿ç”¨ PooledByteBufAllocatorï¼Œè¿™ç§ Allocator ä¸ºäº†å‡å°‘å †å¤–å†…å­˜çš„é‡å¤åˆ†é…ï¼Œä¼šåœ¨æœåŠ¡å†…éƒ¨å»ºç«‹ä¸€ä¸ªå †å¤–å†…å­˜æ± ï¼Œæ¯æ¬¡åˆ†é…å†…å­˜ä¼˜å…ˆä»å†…å­˜æ± åˆ†é…ï¼Œåªæœ‰å†…å­˜æ± æ²¡æœ‰è¶³å¤Ÿå†…å­˜æ—¶å€™ï¼Œæ‰ä¼šå»å †å¤–åˆ†é…æ–°å†…å­˜ã€‚å†…å­˜æ± ä¸Šçš„å†…å­˜è™½ç„¶åœ¨å †å¤–ï¼Œä½†ç»´æŠ¤å†…å­˜æ± çš„æ•°æ®ç»“æ„å´æ˜¯åœ¨å †ä¸Šã€‚éšç€å †å¤–å†…å­˜åˆ†é…çš„å¢å¤šï¼Œå†…éƒ¨ç»´æŠ¤å†…å­˜æ± çš„æ•°æ®ç»“æ„ä¹Ÿä¼šç›¸åº”å¢å¤§ï¼Œå †å†…å†…å­˜ä¹Ÿä¼šæœ‰æ‰€å‡é«˜ã€‚ä¸ºäº†éªŒè¯è¿™ä¸ªçŒœæƒ³ï¼Œæˆ‘ä»¬å°† io.netty.allocator.type è®¾ç½®ä¸º unpooled å†å»æµ‹è¯•ï¼Œå‡ å¤©åå‘ç°å †å†…å†…å­˜ä¾æ—§ä¼šå°å¹…åº¦æ”€å‡ï¼Œä»è€Œåˆ¤å®šå†…å­˜æ³„éœ²å¹¶ä¸æ˜¯ç”±å†…å­˜æ± è€Œå¯¼è‡´ã€‚</p>
<h2 id="é¡ºè—¤æ‘¸ç“œ"><a href="#é¡ºè—¤æ‘¸ç“œ" class="headerlink" title="é¡ºè—¤æ‘¸ç“œ"></a>é¡ºè—¤æ‘¸ç“œ</h2><p>ä¸æ˜¯å†…å­˜æ± å‡ºç°æ³„éœ²ï¼Œè€Œä¸”å †å†…å †å¤–ä¸€èµ·æ³„éœ²ï¼Œèƒ½åŒæ—¶å ç”¨å †å†…å †å¤–å†…å­˜çš„å¯¹è±¡ä¸€èˆ¬ä¸å¤šï¼Œä¸è¿‡ä¸€æ—¶ä¹Ÿæƒ³ä¸å‡ºåˆ°åº•æœ‰å“ªäº›ï¼Œäºæ˜¯éšæ‰‹ dump äº†ä¸€ä»½å †å†…å­˜å¿«ç…§å¼€å§‹åˆ†æï¼Œæœä¸å…¶ç„¶ä»ä¸­è¿˜çœŸçœ‹å‡ºäº†äº›ç«¯å€ªã€‚ä¸€èˆ¬é€šè¿‡ dump æ’æŸ¥å†…å­˜æ³„éœ²éƒ½ä½¿ç”¨ <a href="http://www.eclipse.org/mat/" target="_blank" rel="external">Eclipse Memory Analyzer Tool</a>ï¼ˆç®€ç§° MATï¼‰å»æ£€æŸ¥ dominator treeï¼Œä»ä¸­æ‰¾å‡ºå“ªä¸ªç±»çš„å¯¹è±¡ä¸æ­£å¸¸åœ°å ç”¨äº†å¤§é‡å†…å­˜ã€‚ä½†è¿™æ¬¡çš„ dominator tree çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆé—®é¢˜ã€‚å› ä¸ºå‡ºç°æ³„éœ²çš„å¯¹è±¡åœ¨å †ä¸Šå ç”¨çš„æ€»å†…å­˜å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œå®ƒåœ¨ dominator tree ä¸Šæ ¹æœ¬æ’ä¸åˆ°å‰åˆ—ï¼Œå¾ˆéš¾è¢«å…³æ³¨åˆ°ï¼Œä½†æ˜¯åœ¨ Histogramï¼ˆå¦‚ä¸‹å›¾ï¼‰ä¸­å°±æœ‰å®ƒçš„èº«å½±äº†ã€‚</p>
<p><img src="https://cloud.githubusercontent.com/assets/1115061/16897985/53d4ae34-4bf8-11e6-8170-acc9eee1a42c.png" alt="2016-07-17 7 40 25"></p>
<p>å‡ºç°æ³„éœ²çš„å°±æ˜¯ä¸Šå›¾ç”»çº¢æ¡†åœˆèµ·æ¥çš„ OpenSslClientContextã€‚</p>
<p>ä» OpenSslClientContext çš„ä½¿ç”¨ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªå‡ºé—®é¢˜çš„æœåŠ¡æ˜¯ä½œä¸º client ä¸€ç«¯ï¼Œä½¿ç”¨ OpenSsl å»è¿æ¥å¦ä¸€ä¸ªæœåŠ¡ã€‚ä¸€èˆ¬æ­£å¸¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ª SSL è¯ä¹¦ä¼šåªå¯¹åº”ä¸€ä¸ª OpenSslClientContextã€‚å¯¹äºå¤§å¤šæ•°åœºæ™¯æ¥è¯´ï¼Œæ•´ä¸ªæœåŠ¡å¯èƒ½åªä¼šä½¿ç”¨ä¸€ç§è¯ä¹¦ï¼Œæ‰€ä»¥åªä¼šæœ‰ä¸€ä¸ª OpenSslClientContext ä¿ç•™åœ¨å†…å­˜ä¸­ã€‚ä½†æˆ‘ä»¬è¿™ä¸ªæœåŠ¡æœ‰äº›ç‰¹æ®Šï¼Œä¼šä½¿ç”¨å¾ˆå¤šä¸åŒçš„è¯ä¹¦å»å»ºç«‹ SSL è¿æ¥ï¼Œåªæ˜¯æœåŠ¡åœ¨å†…éƒ¨åšäº†é™åˆ¶ï¼Œå°†åŒä¸€æ—¶åˆ»ä¸åŒè¯ä¹¦å»ºç«‹çš„ SSL è¿æ¥æ•°é‡æ§åˆ¶åœ¨å‡ åä¸ªå·¦å³ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ª SSL è¯ä¹¦ä½¿ç”¨å®Œæ¯•ä¹‹åï¼ŒæŒ‡å‘è¯¥ SSL è¯ä¹¦å¯¹åº” OpenSslClientContext çš„å¼•ç”¨ä¼šè¢«æ¸…ç†æ‰ã€‚ä¹‹åæŒ‰æ­£å¸¸é€»è¾‘æ¥è¯´ OpenSslClientContext ä¼šè¢« GC æ‰ï¼Œä¸ä¼šåœ¨å†…å­˜ä¸­é•¿ä¹…åœç•™ã€‚ä½†æ˜¯ä¸Šå›¾æ˜¾ç¤ºåŒä¸€æ—¶é—´å¹¶å­˜çš„ OpenSslClientContext æœ‰ 27472 ä¸ªä¹‹å¤šï¼Œè¿œè¿œè¶…è¿‡äº†åŸæœ¬æœåŠ¡å†…éƒ¨åœ¨åŒä¸€æ—¶é—´å…è®¸å¹¶å­˜çš„ OpenSslClientContext çš„æ•°é‡é™åˆ¶ï¼Œè¿™å°±æ„å‘³ç€è¿™ä¸ª OpenSslClientContext å‘ç”Ÿäº†æ³„éœ²ã€‚</p>
<p>ä» dump ä¸­æˆ‘ä»¬è¿˜å‘ç°ï¼Œç»´æŠ¤ OpenSslClientContext çš„ä¸šåŠ¡å¯¹è±¡æ²¡æœ‰äº§ç”Ÿæ³„éœ²ï¼Œå¹¶è¢«æ­£å¸¸ GCã€‚è¿™è¯´æ˜æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å¯ä»¥æ­£ç¡®æ¸…ç†æŒ‡å‘ OpenSslClientContext å¯¹è±¡çš„å¼•ç”¨ã€‚é‚£è¿™ä¸ª OpenSslClientContext æ˜¯æ€ä¹ˆè¢« GC Root å¼•ç”¨åˆ°çš„å‘¢ï¼Ÿ</p>
<h2 id="æ°´è½çŸ³å‡º"><a href="#æ°´è½çŸ³å‡º" class="headerlink" title="æ°´è½çŸ³å‡º"></a>æ°´è½çŸ³å‡º</h2><p>ä¾ç„¶æ˜¯ä½¿ç”¨ MATï¼Œåˆ†ææŒ‡å‘æ³„éœ²çš„ OpenSslClientContext å¯¹è±¡çš„å¼•ç”¨è·¯å¾„åå¾—åˆ°å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cloud.githubusercontent.com/assets/1115061/16897983/472ae7fc-4bf8-11e6-8a69-a311827348b0.png" alt="2016-07-13 7 27 37"></p>
<p>å¯ä»¥çœ‹å‡º OpenSslClientContext å¯¹è±¡æŒ‡å‘äº†ä¸¤ä¸ªå¼•ç”¨ï¼Œä¸€ä¸ªæ˜¯ Finalizer ä¸Šçš„å¼•ç”¨ï¼Œä¸€ä¸ªæ˜¯ Native Stack ä¸Šçš„å¼•ç”¨ï¼Œè¿™è¡¨æ˜æˆ‘ä»¬çš„ä¸šåŠ¡å¯¹è±¡å·²ç»æ­£ç¡®åœ°é‡Šæ”¾äº†å¯¹ OpenSslClientContext çš„å¼•ç”¨ã€‚<br>Finalizer å¼•ç”¨çš„å­˜åœ¨æ˜¯å› ä¸º finalize method è¢« OpenSslClientContext  æ‰€ overide äº†ï¼ˆå®é™…æ˜¯ OpenSslClientContext çš„çˆ¶ç±» OpenSslContext æ¥è¿›è¡Œ overideï¼‰ï¼Œè¿™æ · JVM ä¼šä¸ºè¿™ç±»å¯¹è±¡è‡ªåŠ¨åŠ ä¸Š Finalizer å¼•ç”¨ï¼Œä»è€Œåœ¨è¯¥å¯¹è±¡è¢« GC çš„æ—¶å€™è°ƒç”¨å¯¹è±¡çš„ finalize methodã€‚ä½†è¿™ä¸ª Finalizer å¼•ç”¨ä¸ä¼šé˜»ç¢å¯¹è±¡è¢« GCï¼Œæ‰€ä»¥å†…å­˜æ³„éœ²ä¸å®ƒæ²¡æœ‰ç›´æ¥çš„å…³ç³»ã€‚</p>
<p>è€Œ Native Stack å°±æ˜¯ GC Rootï¼Œè¢«å…¶å¼•ç”¨çš„å¯¹è±¡æ˜¯ä¸èƒ½è¢« GC çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ OpenSslClientContext æ³„éœ²çš„æºå¤´ã€‚ä»è¿™ä¸ª Native Stack æŒ‡å‘çš„å¯¹è±¡çš„ç±»å OpenSslClientContext$1 èƒ½çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ª OpenSslClientContext ä¸Šçš„åŒ¿åç±»ã€‚</p>
<p>æŸ¥çœ‹è¿™ä¸ªåŒ¿åç±»çš„å¯¹è±¡çš„å±æ€§ï¼š</p>
<p><img src="https://cloud.githubusercontent.com/assets/1115061/16897981/426fd038-4bf8-11e6-95d7-6b657213c973.png" alt="2016-07-13 9 57 15"></p>
<p>ä¸€æ–¹é¢å®ƒåŒ…å«æœ‰æŒ‡å‘å¤–éƒ¨ OpenSslClientContext çš„å¼•ç”¨ this$0ï¼Œè¿˜åŒ…å«ä¸€ä¸ªå«åš val$extendedManager çš„å¼•ç”¨æŒ‡å‘äº†å¯¹è±¡ sun.security.ssl.X509TrustManagerImplã€‚è¿™æ—¶å€™å»ç¿»çœ‹ Netty 4.1.1-Final çš„ OpenSslClientContext ç¬¬ 240 ~ 268 è¡Œä»£ç å¦‚ä¸‹ï¼ˆæ³¨æ„ç°åœ¨çš„ Netty 4.1 åˆ†æ”¯å·²ç»å°†è¿™ä¸ª bug ä¿®å¤ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥çœ‹åˆ°ä¸‹é¢çš„ä»£ç äº†ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">    if (trustCertCollection != null) &#123;</div><div class="line">        trustManagerFactory = buildTrustManagerFactory(trustCertCollection, trustManagerFactory);</div><div class="line">    &#125; else if (trustManagerFactory == null) &#123;</div><div class="line">        trustManagerFactory = TrustManagerFactory.getInstance(</div><div class="line">                TrustManagerFactory.getDefaultAlgorithm());</div><div class="line">        trustManagerFactory.init((KeyStore) null);</div><div class="line">    &#125;</div><div class="line">    final X509TrustManager manager = chooseTrustManager(trustManagerFactory.getTrustManagers());</div><div class="line"></div><div class="line">    // Use this to prevent an error when running on java &lt; 7</div><div class="line">    if (useExtendedTrustManager(manager)) &#123;</div><div class="line">        final X509ExtendedTrustManager extendedManager = (X509ExtendedTrustManager) manager;</div><div class="line">        SSLContext.setCertVerifyCallback(ctx, new AbstractCertificateVerifier() &#123;</div><div class="line">            @Override</div><div class="line">            void verify(OpenSslEngine engine, X509Certificate[] peerCerts, String auth)</div><div class="line">                    throws Exception &#123;</div><div class="line">                extendedManager.checkServerTrusted(peerCerts, auth, engine);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125; else &#123;</div><div class="line">        SSLContext.setCertVerifyCallback(ctx, new AbstractCertificateVerifier() &#123;</div><div class="line">            @Override</div><div class="line">            void verify(OpenSslEngine engine, X509Certificate[] peerCerts, String auth)</div><div class="line">                    throws Exception &#123;</div><div class="line">                manager.checkServerTrusted(peerCerts, auth);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">    throw new SSLException(&quot;unable to setup trustmanager&quot;, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹æ¯”ä¸Šé¢ MAT ä¸­çœ‹åˆ°çš„ val$extendedManager å¼•ç”¨ä¿¡æ¯æˆ‘ä»¬ä¼šçŸ¥é“ï¼Œä¸Šè¿°ä»£ç  14 ~ 20 è¡Œè®¾ç½®çš„è¿™ä¸ª callback å°±æ˜¯ä¹‹å‰è¯´çš„å‡ºç°æ³„éœ²çš„åŒ¿åç±»ã€‚åŒ¿åç±»æœ‰æŒ‡å‘å¤–éƒ¨å¯¹è±¡ OpenSslClientContext çš„å¼•ç”¨ï¼Œä¹Ÿæœ‰ä¸ªæŒ‡å‘å¤–éƒ¨ extendedManager çš„å¼•ç”¨ã€‚è¿™æ®µé€»è¾‘æ˜¯åœ¨ OpenSslClientContext çš„æ„é€ å‡½æ•°ä¸­çš„ï¼Œè€Œä¸” 12 ~ 29 è¡Œçš„è¿™ä¸ª if è¯­å¥æ— è®ºèµ°å“ªä¸ªåˆ†æ”¯ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ªåŒ¿åçš„ verifier åˆ° SSLContext.setCertVerifyCallbackï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦ new ä¸€ä¸ª OpenSslClientContext å¯¹è±¡ï¼Œå°±ä¸€å®šä¼šè®¾ç½®ä¸€ä¸ª verifier åˆ° Native Stack ä¸Šã€‚</p>
<p>æ‰¾åˆ° SSLContext.setCertVerifyCallback çš„ä»£ç ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨çš„ netty-tcnative-1.1.33.Fork17 ä¸­ï¼ŒSSLContext.setCertVerifyCallback å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Allow to hook &#123;@link CertificateVerifier&#125; into the handshake processing.</div><div class="line"> * This will call &#123;@code SSL_CTX_set_cert_verify_callback&#125; and so replace the default verification</div><div class="line"> * callback used by openssl</div><div class="line"> * @param ctx Server or Client context to use.</div><div class="line"> * @param verifier the verifier to call during handshake.</div><div class="line"> */</div><div class="line">public static native void setCertVerifyCallback(long ctx, CertificateVerifier verifier);</div></pre></td></tr></table></figure>
<p>ä»æ³¨é‡Šä¸Šèƒ½çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥è®©ç”¨æˆ·è‡ªå®šä¹‰è¯ä¹¦æ£€æŸ¥å‡½æ•°ï¼Œå¥½åœ¨ SSL Handshake è¿‡ç¨‹ä¸­æ¥ä½¿ç”¨å»æ ¡éªŒè¯ä¹¦ã€‚</p>
<p>å‡½æ•°å£°æ˜ä¸Šçš„ã€Œnativeã€å…³é”®å­—ä¹Ÿè¡¨æ˜å®ƒæ˜¯é€šè¿‡è°ƒç”¨æœ¬åœ° C ä»£ç å®ç°çš„ã€‚ç»“åˆä¹‹å‰çš„åˆ†æï¼Œèƒ½æ¨ç†å‡ºä¸€å®šæ˜¯è¿™ä¸ª Native ä»£ç å°† verifier callback å­˜å…¥äº† Native Stackï¼Œå¹¶ä¸”åœ¨ OpenSslClientContext æ²¡æœ‰å…¶ä»–å¼•ç”¨æŒ‡å‘æ—¶æ²¡èƒ½å°†è¿™ä¸ª callback æ­£ç¡®æ¸…ç†ï¼Œä»è€Œè®© OpenSslClientContext å¯¹è±¡æœ‰äº†ä» GC Root è¿‡æ¥çš„å¼•ç”¨æŒ‡å‘ï¼Œæ‰€ä»¥ä¸èƒ½è¢« GC æ‰ï¼Œé€ æˆäº†æ³„éœ²ã€‚</p>
<p>æœ‰äº†æŒ‡å¯¼è·¯çº¿ï¼Œæˆ‘ä»¬ç»§ç»­è¿½è¸ªé—®é¢˜ã€‚åœ¨ netty-tcnative-1.1.33.Fork17 çš„ sslcontext.c æ–‡ä»¶ä¸‹æ‰¾åˆ° setCertVerifyCallback å‡½æ•°å¯¹åº”çš„ Native ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">TCN_IMPLEMENT_CALL(void, SSLContext, setCertVerifyCallback)(TCN_STDARGS, jlong ctx, jobject verifier)</div><div class="line">&#123;</div><div class="line">    tcn_ssl_ctxt_t *c = J2P(ctx, tcn_ssl_ctxt_t *);</div><div class="line"></div><div class="line">    UNREFERENCED(o);</div><div class="line">    TCN_ASSERT(ctx != 0);</div><div class="line"></div><div class="line">    if (verifier == NULL) &#123;</div><div class="line">        SSL_CTX_set_cert_verify_callback(c-&gt;ctx, NULL, NULL);</div><div class="line">    &#125; else &#123;</div><div class="line">        jclass verifier_class = (*e)-&gt;GetObjectClass(e, verifier);</div><div class="line">        jmethodID method = (*e)-&gt;GetMethodID(e, verifier_class, &quot;verify&quot;, &quot;(J[[BLjava/lang/String;)I&quot;);</div><div class="line"></div><div class="line">        if (method == NULL) &#123;</div><div class="line">            return;</div><div class="line">        &#125;    </div><div class="line">        // Delete the reference to the previous specified verifier if needed.</div><div class="line">        if (c-&gt;verifier != NULL) &#123;</div><div class="line">            (*e)-&gt;DeleteLocalRef(e, c-&gt;verifier);</div><div class="line">        &#125;    </div><div class="line">        c-&gt;verifier = (*e)-&gt;NewGlobalRef(e, verifier);</div><div class="line">        c-&gt;verifier_method = method;</div><div class="line"></div><div class="line">        SSL_CTX_set_cert_verify_callback(c-&gt;ctx, SSL_cert_verify, NULL);</div><div class="line">    &#125;    </div><div class="line">&#125;       </div></pre></td></tr></table></figure>
<p>è¿™é‡Œå‡½æ•°çš„ verifier å‚æ•°å°±å¯¹åº”ç€ SSLContext.setCertVerifyCallback ä¸Šä¼ å…¥çš„ verifierã€‚è¿™é‡Œä¹Ÿä¸éœ€è¦å®Œå…¨ç†è§£ä¸Šé¢ä»£ç çš„å«ä¹‰ï¼Œä¸»è¦æ˜¯çœ‹åˆ°ç¬¬ 21 è¡Œï¼Œåˆ›å»ºäº†ä¸ªå¼•ç”¨ä» *e æŒ‡å‘äº† verifierã€‚è¿™ä¸ª *e æ˜¯ä¸ª JNIEnv structï¼ŒNewGlobalRef(e, verifier) ç›¸å½“äºå°† verifier ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å˜é‡å½“ä¸­ï¼Œå¿…é¡»é€šè¿‡å¯¹åº”çš„ DeleteGlobalRef æ‰èƒ½é”€æ¯ã€‚</p>
<p>åœ¨æœç´¢ sslcontext.c çš„ä»£ç åå‘ç°åœ¨æ­£å¸¸çš„é€»è¾‘ä¸‹ï¼Œè¦å¯¹ verifier è°ƒç”¨ DeleteGlobalRef å°†å…¶æ¸…ç†ï¼Œå¿…é¡»è°ƒç”¨ SSLContext.free å‡½æ•°æ‰èƒ½å®ç°ã€‚SSLContext.free å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><figcaption><span>java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Free the resources used by the Context</div><div class="line"> * @param ctx Server or Client context to free.</div><div class="line"> * @return APR Status code.</div><div class="line"> */</div><div class="line">public static native int free(long ctx);</div></pre></td></tr></table></figure>
<p>å®ƒè¿˜æœ‰ä¸ªå¯¹åº”çš„ make å‡½æ•°ï¼Œåˆå¹¶èµ·æ¥ç”¨äºè´Ÿè´£ OpenSslClientContext åˆ†é…å’Œå›æ”¶ä¸€äº› Native çš„èµ„æºã€‚OpenSslClientContext åœ¨æ„é€ å‡½æ•°ä¸­å¿…é¡»è°ƒç”¨ä¸€æ¬¡ SSLContext.makeï¼Œåœ¨å¯¹è±¡è¢«é”€æ¯æ—¶éœ€è¦è°ƒç”¨ SSLContext.freeã€‚ã€Œåœ¨å¯¹è±¡è¢«é”€æ¯æ—¶è°ƒç”¨ã€å¬ä¸Šå»æœ‰ç‚¹ææ„å‡½æ•°çš„æ„æ€ï¼Œä½† Java ä¸­æ²¡æœ‰ææ„å‡½æ•°çš„æ¦‚å¿µï¼Œçœ‹ä¸Šå» Netty ä¹Ÿæ²¡æœ‰å¥½çš„æ–¹æ³•æ¥å®ç°è¿™ç§ç±»ä¼¼ææ„å‡½æ•°çš„åŠŸèƒ½ï¼Œè™½ç„¶æ‰€æœ‰è®²åˆ° finalize çš„åœ°æ–¹éƒ½åœ¨è°†è°†å‘Šè¯«å¼€å‘è€…åªæ˜¯çŸ¥æ™“å®ƒçš„å­˜åœ¨å°±å¥½ä½†æ°¸è¿œä¸è¦å»ä½¿ç”¨ï¼ŒNetty è¿˜æ˜¯ã€Œè¢«é€¼æ— å¥ˆã€åœ°å°†ç”¨äºèµ„æºå›æ”¶çš„ SSLContext.free è°ƒç”¨æ”¾åœ¨äº† OpenSslClientContext çš„ finalizeï¼ˆç»§æ‰¿è‡ª OpenSslContextï¼‰å‡½æ•°ä¸­ã€‚</p>
<p>åˆ†æåˆ°è¿™é‡ŒåŸºæœ¬å°±èƒ½å¾—åˆ° OpenSslClientContext æ³„éœ²çš„åŸå› äº†ã€‚å› ä¸º OpenSslClientContext åœ¨æ„é€ æ—¶ä¼šå°†ä¸€ä¸ªåŒ¿åçš„ AbstractCertificateVerifier å­ç±»å¯¹è±¡ä½œä¸ºè¯ä¹¦çš„æ ¡éªŒå‡½æ•°ï¼ˆç®€ç§°ä¸º verifierï¼‰ï¼Œé€šè¿‡è°ƒç”¨ SSLContext.setCertVerifyCallback å­˜å‚¨åˆ° Native Stack ä¸Šï¼Œå¿…é¡»åœ¨ OpenSslClientContext é”€æ¯æ—¶ä¸»åŠ¨è°ƒç”¨ SSLContext.free æ‰èƒ½å°†è¿™ä¸ª verifier ä» Native Stack æ¸…é™¤ã€‚è€Œ SSLContext.free æ˜¯åœ¨ OpenSslClientContext çš„ finalize å†…ï¼Œå¿…é¡»ç­‰åˆ° OpenSslClientContext è¢« GC æ‰ä¹‹åæ‰ä¼šè¢«è°ƒç”¨ã€‚ç”±äº verifier æ˜¯ä¸ªåŒ¿åç±»ï¼Œå®ƒå«æœ‰éšå«çš„æŒ‡å‘äº†å…¶æ‰€å± OpenSslClientContext çš„å¼•ç”¨ï¼Œå¯¼è‡´å½“ verifier ä¸è¢«é”€æ¯æ—¶ï¼Œå…¶æ‰€åœ¨ OpenSslClientContext ä¹Ÿæ— æ³•é”€æ¯ï¼Œä»è€Œäº§ç”Ÿä¾èµ–ç¯ï¼Œverifier çš„æ¸…ç†ä¾èµ– OpenSslClientContext çš„æ¸…ç†ï¼ŒOpenSslClientContext çš„æ¸…ç†åˆä¾èµ– verifier çš„æ¸…ç†ã€‚è¿™ç§ä¾èµ–ç¯å¦‚æœéƒ½æ˜¯åœ¨å †å†…ï¼ŒJVM GC çš„æ—¶å€™ä¼šè‡ªåŠ¨æ£€æµ‹ä¾èµ–ç¯ï¼Œå¹¶å°†ç›¸äº’ä¾èµ–çš„ä¸¤ä¸ªå¯¹è±¡å…¨éƒ¨ GC æ‰ã€‚ä½†è¿™é‡Œ verifier æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ˜¯ç›´æ¥å­˜å‚¨åœ¨ Native Stack ä¸Šçš„ï¼ŒJVM GC æ‹¿å®ƒæ²¡æœ‰åŠæ³•ã€‚JVM GC çš„ç®¡è¾–èŒƒå›´åªæœ‰å †ï¼ŒNative Stack å¯ä»¥ç†è§£ä¸ºæ˜¯å®ƒçš„ä¸Šçº§ï¼Œå®ƒæ— æƒè¿‡é—®ã€‚</p>
<p>å¦å¤–è¡¥å……ä¸€ç‚¹ï¼Œä¸Šè¿°é—®é¢˜è™½ç„¶æ˜¯åœ¨ OpenSslClientContext ä¸­å‘ç°ï¼Œä½† OpenSslServerContext ä¸­ä¹Ÿæœ‰ç›¸åŒé—®é¢˜ã€‚</p>
<h1 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h1><p>Bug æ‰¾åˆ°äº†ï¼Œå…·ä½“çš„ PR è¯·å‚è€ƒ<a href="https://github.com/netty/netty/pull/5380" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚ä¿®å¤åŠæ³•å°±æ˜¯å°†å¯¼è‡´æ³„éœ²çš„åŒ¿å AbstractCertificateVerifier å­ç±»å¯¹è±¡ä¿®æ”¹ä¸º static çš„å†…éƒ¨ç±»ï¼Œè¿™æ ·å®ƒä¸ä¼šåŒ…å«æŒ‡å‘å…¶æ‰€åœ¨å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼ˆå³ OpenSslClientContextï¼‰ï¼Œä»è€Œä¸ä¼šé˜»ç¢å¤–éƒ¨ç±»çš„ GCï¼Œä¹Ÿå°±é¿å…äº†æ³„éœ²çš„å‘ç”Ÿã€‚</p>
<p>é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†ç©¶å…¶æ ¹æœ¬åŸå› æ˜¯ä¸æ˜¯å¯ä»¥å½’ç»“åˆ° finalize å‡½æ•°çš„ä½¿ç”¨å‘¢ï¼Ÿå¦‚æœ OpenSslClientContext æ²¡æœ‰ä½¿ç”¨ finalizeï¼Œè€Œæ˜¯æš´éœ²ä¸€ä¸ªç±»ä¼¼ close çš„æ¥å£ï¼Œè¦æ±‚ OpenSslClientContext çš„ä½¿ç”¨è€…ä¸»åŠ¨è°ƒç”¨ closeï¼Œfinalize å†…åªæ˜¯æ‰“å°æ—¥å¿—ï¼Œæé†’ä½¿ç”¨è€…æ²¡æœ‰è°ƒç”¨ closeï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ä¸æ˜¯ä»ä¸€å¼€å§‹å°±ä¸ä¼šå­˜åœ¨äº†å‘¢ï¼Ÿ<br>ä¸€èˆ¬æ¥è¯´ finalize å‡ºç°çš„é—®é¢˜ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼š</p>
<ol>
<li>ä½¿ç”¨ finalize çš„å¯¹è±¡åœ¨åˆ›å»ºå’Œé”€æ¯æ—¶æ€§èƒ½æ¯”æ­£å¸¸çš„å¯¹è±¡å·®ï¼›</li>
<li>finalize æ‰§è¡Œæ—¶é—´ä¸ç¡®å®šã€‚å¯èƒ½å‡ºç° heap å†…è™½ç„¶æœ‰å¾ˆå¤šæ‹¥æœ‰ finalize å‡½æ•°çš„ç±»å¯¹è±¡ï¼Œä¸”è¿™äº›å¯¹è±¡éƒ½å·²æ­»æ‰ï¼ˆä» GC Root æ— æ³•è®¿é—®ï¼‰ï¼Œå¦‚æœé‡åˆ° GC å‹åŠ›æ¯”è¾ƒå¤§ç­‰åŸå› ï¼Œè¿™äº›å¯¹è±¡çš„ finalize è¿˜æ²¡æœ‰è¢«è§¦å‘ï¼Œå°±ä¼šå¯¼è‡´è¿™äº›æœ¬æ¥è¯¥è¢« GC ä½†æ²¡æœ‰è¢« GC çš„å¯¹è±¡å¤§é‡å­˜åœ¨äº Heap ä¸­ã€‚</li>
</ol>
<p>çŒœæƒ³ Netty è¿™é‡Œä½¿ç”¨ finalize è€Œä¸æ˜¯æ˜ç¡®æä¾›ä¸€ä¸ª close å‡½æ•°ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿ï¼Œæ¯•ç«Ÿ OpenSslContext åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹åœ¨ä¸€ä¸ªæœåŠ¡ä¸­åªå­˜åœ¨ä¸€ä¸¤ä¸ªå¯¹è±¡ï¼Œéœ€è¦å°†å…¶é”€æ¯çš„æƒ…å†µä¹Ÿè®¸ä¹Ÿä¸æ˜¯å¾ˆå¤šã€‚ä»¥ä¸ŠçŒœæƒ³<a href="https://github.com/netty/netty/issues/4958" target="_blank" rel="external">åœ¨è¿™ä¸ª issue </a>ä¸­ä¹Ÿå¾—åˆ°äº†ä¸€å®šç¨‹åº¦çš„å°è¯ï¼Œ<a href="https://github.com/netty/netty/pull/5547" target="_blank" rel="external">å¹¶ä¸” Netty å·²ç»åœ¨ä¿®æ”¹è¿™ä¸ªé—®é¢˜</a>ï¼Œè®© OpenSslContext å®ç° ReferenceCount æ¥å£ï¼Œåœ¨ finalize ä¹‹å¤–åˆæä¾›äº† release å‡½æ•°ä¸“é—¨ç”¨äºæ¸…ç† Native èµ„æºã€‚</p>
<p>æ‰€ä»¥åˆ†äº«è¿™äº›ç»éªŒæ¥è®©å¤§å®¶å¼•ä»¥ä¸ºæˆ’ï¼Œfinalize è¦å°½é‡å°‘ç”¨ï¼Œçœ‹ç€ä»¥ä¸ºä½¿ç”¨ finalize å¾ˆåˆç†çš„åœ°æ–¹è¿˜æ˜¯æœ‰å¯èƒ½å‡ºç°é—®é¢˜ã€‚</p>

	

	

</article>






	<span class="different-posts">ğŸ“• end of posts ğŸ“•</span>

